---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Setting up your organization">
  <main class="flex min-h-screen flex-col items-center justify-center bg-slate-950 text-white p-4">
    <div class="max-w-md w-full p-8 bg-slate-900 rounded-2xl border border-slate-800 shadow-xl">
      
      <div id="status-icon" class="flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-6 mx-auto">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      </div>
      
      <h1 id="status-title" class="text-2xl font-bold text-center mb-2">Syncing Repositories...</h1>
      <p id="status-text" class="text-slate-400 text-center mb-8">
        We are fetching your repositories from GitHub. This won't take long.
      </p>

      <div class="space-y-4">
        <div class="p-4 bg-slate-950 rounded-lg border border-slate-800">
          <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Internal Org ID</label>
          <div id="org-id-display" class="font-mono text-sm text-blue-400 mt-1 break-all">
            ...
          </div>
        </div>

        <div class="pt-6 flex flex-col items-center gap-3 w-full"> 
          <a 
            id="dashboard-button"
            href="/dashboard" 
            class="hidden w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white text-center font-medium rounded-lg transition-all transform scale-95 opacity-0 shadow-lg shadow-blue-500/20"
          >
            Open Dashboard
          </a>

          <button 
            id="refresh-button"
            class="hidden text-sm text-slate-400 hover:text-white flex items-center gap-2 transition-colors py-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Try Again
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  let pollingInterval;
  let errorCount = 0;

  async function pollSyncStatus() {
    const params = new URLSearchParams(window.location.search);
    const orgId = params.get('org_id');
    const displayElement = document.getElementById('org-id-display');
    const statusTitle = document.getElementById('status-title');
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('status-icon');
    const dashboardBtn = document.getElementById('dashboard-button');
    const refreshBtn = document.getElementById('refresh-button');
    const API_BASE_URL = import.meta.env.PUBLIC_API_URL;

    if (!orgId) {
      if (displayElement) displayElement.textContent = 'Org ID missing';
      return;
    }

    displayElement.textContent = orgId;

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    let attempts = 0;
    const maxAttempts = 20;
    const maxErrors = 5;
    errorCount = 0;
    refreshBtn.classList.add('hidden');

    if (pollingInterval) clearInterval(pollingInterval);

    pollingInterval = setInterval(async () => {
      attempts++;

      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–≥–æ –ª–∏–º–∏—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
      if (attempts > maxAttempts) {
        clearInterval(pollingInterval);
        statusTitle.textContent = "Sync taking too long";
        statusText.textContent = "We're still working on it. You can try refreshing or go to the dashboard anyway.";
        statusIcon.innerHTML = `<span class="text-yellow-500 text-3xl">‚è≥</span>`;
        statusIcon.className = "flex items-center justify-center w-16 h-16 bg-yellow-500/20 rounded-full mb-6 mx-auto";
        
        refreshBtn.classList.remove('hidden');
        dashboardBtn.classList.remove('hidden');
        dashboardBtn.textContent = "Go to Dashboard anyway";
        setTimeout(() => dashboardBtn.classList.add('scale-100', 'opacity-100'), 50);
        return;
      }

      try {
        const url = `${API_BASE_URL}/organizations/${orgId}`;
        const response = await fetch(url, {
            headers: { 'ngrok-skip-browser-warning': 'true' }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        errorCount = 0; // –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏

        if (data.status === 'completed') {
          clearInterval(pollingInterval);
          statusTitle.textContent = "Completed!";
          statusText.textContent = `Successfully synced ${data.repo_count || 0} repositories.`;
          statusIcon.innerHTML = `<div class="bg-green-500 rounded-full p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div>`;
          statusIcon.className = "flex items-center justify-center w-16 h-16 bg-green-500/20 rounded-full mb-6 mx-auto";
          
          refreshBtn.classList.add('hidden');
          dashboardBtn.classList.remove('hidden');
          dashboardBtn.textContent = "Open Dashboard";
          setTimeout(() => dashboardBtn.classList.add('scale-100', 'opacity-100'), 50);
        }
        
        if (data.status === 'failed') {
          clearInterval(pollingInterval);
          statusTitle.textContent = "Sync Failed";
          statusText.textContent = data.sync_error || "Something went wrong during synchronization.";
          statusIcon.innerHTML = `<span class="text-red-500 text-3xl">‚ö†Ô∏è</span>`;
          statusIcon.className = "flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-6 mx-auto";
          refreshBtn.classList.remove('hidden');
        }
        console.log("attempts", attempts);
      } catch (err) {
        errorCount++;
        console.error(`Attempt ${attempts} failed:`, err);

        if (errorCount >= maxErrors) {
          clearInterval(pollingInterval);
          statusTitle.textContent = "Connection Error";
          statusText.textContent = "We're having trouble reaching the server. Please check your connection.";
          statusIcon.innerHTML = `<span class="text-red-500 text-3xl">üì°</span>`;
          statusIcon.className = "flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-6 mx-auto";
          refreshBtn.classList.remove('hidden');
        }
      }
    }, 2000);
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Refresh
  document.getElementById('refresh-button')?.addEventListener('click', () => {
    const statusIcon = document.getElementById('status-icon');
    const statusTitle = document.getElementById('status-title');
    const statusText = document.getElementById('status-text');
    
    statusIcon.innerHTML = '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>';
    statusIcon.className = "flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-6 mx-auto";
    statusTitle.textContent = "Retrying sync...";
    statusText.textContent = "Checking the status again...";
    
    pollSyncStatus();
  });

  // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  pollSyncStatus();
</script>