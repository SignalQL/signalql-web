---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Setting up your organization">
  <main class="flex min-h-screen flex-col items-center justify-center bg-slate-950 text-white">
    <div class="max-w-md w-full p-8 bg-slate-900 rounded-2xl border border-slate-800 shadow-xl">
      
      <div id="status-icon" class="flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-6 mx-auto">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      </div>
      
      <h1 id="status-title" class="text-2xl font-bold text-center mb-2">Syncing Repositories...</h1>
      <p id="status-text" class="text-slate-400 text-center mb-8">
        We are fetching your repositories from GitHub. This won't take long.
      </p>

      <div class="space-y-4">
        <div class="p-4 bg-slate-950 rounded-lg border border-slate-800">
          <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Internal Org ID</label>
          <div id="org-id-display" class="font-mono text-sm text-blue-400 mt-1 break-all">
            ...
          </div>
        </div>

        <div class="pt-6"> 
          <a 
            id="dashboard-button"
            href="/dashboard" 
            class="hidden w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white text-center font-medium rounded-lg transition-all transform scale-95 opacity-0 shadow-lg shadow-blue-500/20"
          >
            Open Dashboard
          </a>
        </div>
      </div>
  </main>
</Layout>

<script>
  async function pollSyncStatus() {
    const params = new URLSearchParams(window.location.search);
    const orgId = params.get('org_id');
    const displayElement = document.getElementById('org-id-display');
    const statusTitle = document.getElementById('status-title');
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('status-icon');
    const dashboardBtn = document.getElementById('dashboard-button');
    const API_BASE_URL = import.meta.env.PUBLIC_API_URL;

    if (!orgId) {
      if (displayElement) displayElement.textContent = 'Org ID missing';
      return;
    }

    displayElement.textContent = orgId;

    let errorCount = 0;
    let attempts = 0;
    const maxAttempts = 20; 

    const interval = setInterval(async () => {
      attempts++;

      // 1. Проверяем лимит попыток ДО запроса или гарантированно в каждом цикле
      if (attempts >= maxAttempts) {
        clearInterval(interval);
        statusTitle.textContent = "Sync taking too long";
        statusText.textContent = "We're still working on it, but you can check back later in the dashboard.";
        statusIcon.innerHTML = `<span class="text-yellow-500 text-3xl">⏳</span>`;
        
        dashboardBtn.classList.remove('hidden');
        dashboardBtn.classList.add('scale-100', 'opacity-100');
        dashboardBtn.textContent = "Go to Dashboard anyway";
        return; // Выходим из текущей итерации
      }

      try {
        const url = `${API_BASE_URL}/api/organizations/${orgId}`;
        const response = await fetch(url, {
            headers: { 'ngrok-skip-browser-warning': 'true' }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();

        // Логика обработки статусов
        if (data.status === 'completed') {
          clearInterval(interval);
          statusTitle.textContent = "Completed!";
          statusText.textContent = `Successfully synced ${data.repo_count || 0} repositories.`;
          statusIcon.innerHTML = `<svg ...>...</svg>`; // твой SVG
          statusIcon.className = "flex items-center justify-center w-16 h-16 bg-green-500/20 rounded-full mb-6 mx-auto";
          
          dashboardBtn.classList.remove('hidden');
          setTimeout(() => dashboardBtn.classList.add('scale-100', 'opacity-100'), 50);
        }
        
        if (data.status === 'failed') {
          clearInterval(interval);
          statusTitle.textContent = "Sync Failed";
          statusText.textContent = data.sync_error || "Something went wrong.";
          statusIcon.innerHTML = `<span class="text-red-500 text-2xl">⚠️</span>`;
        }

        // If the status is 'pending' or 'in_progress', do nothing, wait for the next iteration
        console.log("Trying #", attempts);

      } catch (err) {
        console.error("Polling attempt failed:", attempts, err);
        // Check if we've reached the maximum number of attempts
        if (errorCount >= maxAttempts) {
          clearInterval(interval);
          statusTitle.textContent = "Too many errors";
          statusText.textContent = "We've tried too many times. Please try again later.";
          statusIcon.innerHTML = `<span class="text-red-500 text-2xl">⚠️</span>`;
          return;
        }
        errorCount++;
      }
    }, 2000); 
  }

  pollSyncStatus();
</script>